% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/api.R
\name{fit_mfrm}
\alias{fit_mfrm}
\title{Fit a many-facet Rasch model with a flexible number of facets}
\usage{
fit_mfrm(
  data,
  person,
  facets,
  score,
  rating_min = NULL,
  rating_max = NULL,
  weight = NULL,
  keep_original = FALSE,
  model = c("RSM", "PCM"),
  method = c("MML", "JML", "JMLE"),
  step_facet = NULL,
  anchors = NULL,
  group_anchors = NULL,
  noncenter_facet = "Person",
  dummy_facets = NULL,
  positive_facets = NULL,
  anchor_policy = c("warn", "error", "silent"),
  min_common_anchors = 5L,
  min_obs_per_element = 30,
  min_obs_per_category = 10,
  quad_points = 15,
  maxit = 400,
  reltol = 1e-06
)
}
\arguments{
\item{data}{A data.frame with one row per observation.}

\item{person}{Column name for the person (character scalar).}

\item{facets}{Character vector of facet column names.}

\item{score}{Column name for observed category score.}

\item{rating_min}{Optional minimum category value.}

\item{rating_max}{Optional maximum category value.}

\item{weight}{Optional weight column name.}

\item{keep_original}{Keep original category values.}

\item{model}{\code{"RSM"} or \code{"PCM"}.}

\item{method}{\code{"MML"} (default) or \code{"JML"} / \code{"JMLE"}.}

\item{step_facet}{Step facet for PCM.}

\item{anchors}{Optional anchor table.}

\item{group_anchors}{Optional group-anchor table.}

\item{noncenter_facet}{One facet to leave non-centered.}

\item{dummy_facets}{Facets to fix at zero.}

\item{positive_facets}{Facets with positive orientation.}

\item{anchor_policy}{How to handle anchor-audit issues: \code{"warn"} (default),
\code{"error"}, or \code{"silent"}.}

\item{min_common_anchors}{Minimum anchored levels per linking facet used in
anchor-audit recommendations.}

\item{min_obs_per_element}{Minimum weighted observations per facet level used
in anchor-audit recommendations.}

\item{min_obs_per_category}{Minimum weighted observations per score category
used in anchor-audit recommendations.}

\item{quad_points}{Quadrature points for MML.}

\item{maxit}{Maximum optimizer iterations.}

\item{reltol}{Optimization tolerance.}
}
\value{
An object of class \code{mfrm_fit} (named list) with:
\itemize{
\item \code{summary}: one-row model summary (\code{LogLik}, \code{AIC}, \code{BIC}, convergence)
\item \code{facets$person}: person estimates (\code{Estimate}; plus \code{SD} for MML)
\item \code{facets$others}: facet-level estimates for each facet
\item \code{steps}: estimated threshold/step parameters
\item \code{config}: resolved model configuration used for estimation
(includes \code{config$anchor_audit})
\item \code{prep}: preprocessed data/level metadata
\item \code{opt}: raw optimizer result from \code{\link[stats:optim]{stats::optim()}}
}
}
\description{
This is the package entry point. It wraps \code{mfrm_estimate()} and defaults to
\code{method = "MML"}. Any number of facet columns can be supplied via \code{facets}.
}
\details{
Data must be in \strong{long format} (one row per observed rating event).
}
\section{Input requirements}{

Minimum required columns are:
\itemize{
\item person identifier (\code{person})
\item one or more facet identifiers (\code{facets})
\item observed score (\code{score})
}

Scores are treated as ordered categories.
If your observed categories do not start at 0, set \code{rating_min}/\code{rating_max}
explicitly to avoid unintended recoding assumptions.

Supported model/estimation combinations:
\itemize{
\item \code{model = "RSM"} with \code{method = "MML"} or \code{"JML"/"JMLE"}
\item \code{model = "PCM"} with a designated \code{step_facet} (defaults to first facet)
}

Anchor inputs are optional:
\itemize{
\item \code{anchors} should contain facet/level/fixed-value information.
\item \code{group_anchors} should contain facet/level/group/group-value information.
Both are normalized internally, so column names can be flexible
(\code{facet}, \code{level}, \code{anchor}, \code{group}, \code{groupvalue}, etc.).
}

Anchor audit behavior:
\itemize{
\item \code{fit_mfrm()} runs an internal anchor audit.
\item invalid rows are removed before estimation.
\item duplicate rows keep the last occurrence for each key.
\item \code{anchor_policy} controls whether detected issues are warned, treated as
errors, or kept silent.
}

Facet sign orientation:
\itemize{
\item facets listed in \code{positive_facets} are treated as \code{+1}
\item all other facets are treated as \code{-1}
This affects interpretation of reported facet measures.
}
}

\section{Interpreting output}{

A typical first-pass read is:
\enumerate{
\item \code{fit$summary} for convergence and global fit indicators.
\item \code{summary(fit)} for human-readable overviews.
\item \code{diagnose_mfrm(fit)} for element-level fit, separation, and warning tables.
}
}

\section{Typical workflow}{

\enumerate{
\item Fit the model with \code{fit_mfrm(...)}.
\item Validate convergence and scale structure with \code{summary(fit)}.
\item Run \code{\link[=diagnose_mfrm]{diagnose_mfrm()}} and proceed to reporting with \code{\link[=build_apa_outputs]{build_apa_outputs()}}.
}
}

\examples{
toy <- expand.grid(
  Person = paste0("P", 1:4),
  Rater = paste0("R", 1:2),
  Criterion = c("Content", "Organization", "Language"),
  stringsAsFactors = FALSE
)
toy$Score <- (
  as.integer(factor(toy$Person)) +
  2 * as.integer(factor(toy$Rater)) +
  as.integer(factor(toy$Criterion))
) \%\% 3

fit <- fit_mfrm(
  data = toy,
  person = "Person",
  facets = c("Rater", "Criterion"),
  score = "Score",
  method = "JML",
  model = "RSM",
  maxit = 25
)
fit$summary
s_fit <- summary(fit)
s_fit$overview[, c("Model", "Method", "Converged")]
p_fit <- plot(fit, draw = FALSE)
class(p_fit)

# MML is the default:
fit_mml <- fit_mfrm(
  data = toy,
  person = "Person",
  facets = c("Rater", "Criterion"),
  score = "Score",
  model = "RSM",
  quad_points = 7,
  maxit = 25
)
summary(fit_mml)
}
\seealso{
\code{\link[=diagnose_mfrm]{diagnose_mfrm()}}, \code{\link[=estimate_bias]{estimate_bias()}}, \code{\link[=build_apa_outputs]{build_apa_outputs()}}
}
